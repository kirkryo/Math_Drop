<!DOCTYPE html>
<html lang='en'>
<head>
	<meta charset="UTF-8">
	<title>Math Drop</title>
	<style>
		canvas {
			border:1px solid black;
		}
	</style>
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
</head>
<body class='text-center'>
	<h1>score: <span id='score'>0</span>&nbsp;<input id='input' autofocus/></h1>
	<canvas id='gc'></canvas>
	<p></p>
</body>
<script>
	var score = 0;
	var operations = Array();

	game();

	function game() {
		gameCanvas();
		spawnRandomEquation();
		killEquations();
		drawOp();
		moveOp();	
	}

	function gameCanvas() {
		var canvas = document.querySelector('canvas');

		canvas.width = 1000;
		canvas.height = 500;

		var c = canvas.getContext('2d');
		console.log(canvas);
	}

	function drawOp() {
		var canvas = document.querySelector('canvas');
		var c = canvas.getContext('2d');
		c.clearRect(0, 0, 1000, 500);

		operations.forEach( function (opObj){
			c.font = "30px Arial";
			c.fillText(opObj.operation,opObj.x,opObj.y);
		})
		setTimeout(drawOp, 1);
	}

	function moveOp() {
		vy = getSpeed(score); //	vertical veloicty
		operations.forEach( function (opObj){
			opObj.y = opObj.y + vy;
			if (opObj.y >= 500) {
				endGame();
				die();
			}
		})
		setTimeout(moveOp, 50);
	}

	function getSpeed(score) { //	WiP
		if (score < 5) {
			return 1;
		} else if (score < 10) {
			return 2;
		} else if (score < 15) {
			return 2.9;
		} else if (score < 20) {
			return 3.7;
		} else if (score < 25) { 
			return 4.4;
		} else if (score < 30) {
			return 5.0;
		} else if (score < 35) {
			return 5.5;
		} else if (score < 40) {
			return 5.9;
		} else if (score < 45) {
			return 6.2;
		} else if (score < 50) {
			return 6.4;
		} else if (score < 55) {
			return 6.5;
		} else if (score < 60) {
			return 6.6;
		} else if (score < 65) {
			return 6.7;
		} else if (score < 70) {
			return 6.8;
		} else if (score < 75) {
			return 6.9;
		} else if (score < 80) {
			return 7.0;
		} else if (score = 100) {
			endGame();
			die();
		}
 	}

	function getSpawnRate(score) {
		if (score < 5) {
			return 2000;
		} else if (score < 10) {
			return 1700;
		} else if (score < 15) {
			return 1400;
		} else if (score < 20) {
			return 1200;
		} else { //zerg
			return 1000;
		}
	}

	function getStartingPosition() {
		var x = Math.floor(Math.random() * 970);
		return x;
	}
	
	function spawnRandomEquation() {
		var possible_op = "+-*/";
		for (var i = 0; i < 1; i++) {
			op = possible_op.charAt(Math.floor(Math.random() * possible_op.length));
		}
		var num1 = Math.floor((Math.random() * 9)+1);
		var num2 = Math.floor((Math.random() * 9)+1);


		if (op == '/') {
			while (checkDiv(num1, num2) == false) {
				var num1 = Math.floor((Math.random() * 9)+1);
				var num2 = Math.floor((Math.random() * 9)+1);
			}
			if (checkDiv(num1, num2) == 'flip') {
				var temp = num1;
				num1 = num2;
				num2 = temp;
			}
		}

		if (op == "-") {
			while (checkSub(num1, num2) == false) {
				var num1 = Math.floor((Math.random() * 9)+1);
				var num2 = Math.floor((Math.random() * 9)+1);
			}
		}

		var operation = num1 + op + num2;
		var result = eval(operation);
		var x = getStartingPosition();

		var object = {operation: operation, result: result, x: x, y: 0};

		operations.push(object);

		rate = getSpawnRate(score);

		setTimeout(spawnRandomEquation, rate);
	}

	function checkSub(n1, n2) {
		if (n1 < n2) {
			return false;
		} else {
			return true;
		}
	}
 
	function checkDiv(n1, n2) {
		if (n1 % n2 != 0) {
			if (n2 % n1 != 0) {
				//n1 = Math.floor((Math.random() * 9)+1);
				//n2 = Math.floor((Math.random() * 9)+1);
				//checkDiv(n1, n2);
				return false;
			} else {
				return 'flip';	
			}
		} else {
			return true;
		}
	}

	function killEquations() {
		document.getElementById('input').onkeypress = function(e){
		    if (!e) e = window.event;
		    if (e.keyCode == '13'){
		    	//alert(this.value);

		    	var result = this.value;

		    	var obj = operations.find(o => o.result == result);

		        var index = operations.indexOf(obj);

		        if (index > -1) {
				    operations.splice(index, 1);
				    score++;
				    document.getElementById('score').innerHTML = score;
				}
				e.currentTarget.value = '';
		    }
		}
		/*
		document.addEventListener("keypress", function(event) {
    		if (event.keyCode) {
		    	var char = String.fromCharCode(event.keyCode);

		        var obj = characters.find(o => o.char === char);

		        var index = characters.indexOf(obj);

		        if (index > -1) {
				    characters.splice(index, 1);
				    score++;
				    document.getElementById('score').innerHTML = score;
				}
    		}
		})
		*/
	}

	function endGame() {
		string = "Game over! Your score is: " + score; 
		alert(string);
		operations = [];
        document.location.reload();
	}	
</script>